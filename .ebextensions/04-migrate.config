container_commands:
  01_install_and_migrate:
    command: |
      # Debug environment
      env > /tmp/eb-env-debug.log
      # Install pnpm directly via npm
      echo "Installing pnpm via npm..."
      npm install -g pnpm@10
      
      # Add to path and verify installation
      export PATH="/usr/local/bin:$PATH"
      pnpm --version || { echo "pnpm installation failed"; exit 0; }
      
      # Set SSL mode
      export PGSSLMODE=require
      
      # Run migrations with retry
      for i in {1..3}; do
        echo "Migration attempt $i..."
        if pnpm run db:migrate:prod; then
          echo "Migration successful"
          exit 0
        fi
        echo "Migration failed, retrying in 5 seconds..."
        sleep 5
      done
      echo "Migration failed after 3 attempts"
      exit 0
    leader_only: true
    cwd: /var/app/staging
    env:
      NODE_ENV: production